"use strict";(self.webpackChunkdocument_sample=self.webpackChunkdocument_sample||[]).push([[5320],{9865:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>r,frontMatter:()=>s,metadata:()=>d,toc:()=>c});var o=i(4848),t=i(8453);const s={id:"epoching",sidebar_label:"Epoching Module",hide_table_of_contents:!0},a="Epoching Module",d={id:"developer-guides/modules/epoching",title:"Epoching Module",description:"Learn what the Babylon Epoching Module is and how it operates.",source:"@site/docs/developer-guides/modules/epoching.md",sourceDirName:"developer-guides/modules",slug:"/developer-guides/modules/epoching",permalink:"/docs/developer-guides/modules/epoching",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/developer-guides/modules/epoching.md",tags:[],version:"current",frontMatter:{id:"epoching",sidebar_label:"Epoching Module",hide_table_of_contents:!0},sidebar:"docs",previous:{title:"Babylon Modules",permalink:"/docs/developer-guides/modules/overview"},next:{title:"Checkpointing Module",permalink:"/docs/developer-guides/modules/checkpointing"}},l={},c=[{value:"Summary",id:"summary",level:2},{value:"Problem Statement",id:"problem-statement",level:2},{value:"Design",id:"design",level:2},{value:"Dividing the Blockchain into Epochs",id:"dividing-the-blockchain-into-epochs",level:3},{value:"Disabling Functionalities of the Staking Module",id:"disabling-functionalities-of-the-staking-module",level:3},{value:"Disabling Messages of the Staking Module",id:"disabling-messages-of-the-staking-module",level:3},{value:"Delaying Wrapped Messages to the End of Epochs",id:"delaying-wrapped-messages-to-the-end-of-epochs",level:3},{value:"Bitcoin-assisted Unbonding",id:"bitcoin-assisted-unbonding",level:3}];function h(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"epoching-module",children:"Epoching Module"}),"\n",(0,o.jsx)(n.p,{children:"Learn what the Babylon Epoching Module is and how it operates."}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,o.jsx)(n.p,{children:"The epoching module is responsible for reducing and parameterising the frequency of updating the validator set in Babylon.\nThe Babylon blockchain is divided into epochs, and each epoch contains a fixed number of consecutive blocks.\nAll staking-related messages (creating validator, delegating, undelegating, and redelegating) are enqueued to the message queue of the current epoch.\nAt the end of each epoch, the epoching module will execute all staking-related messages, then update the validator set w.r.t. the voting power distribution of validators.\nAfter that, the checkpointing module will generate a checkpoint containing the commitment to the epoch's validator set, then submit the checkpoint to Bitcoin."}),"\n",(0,o.jsx)(n.h2,{id:"problem-statement",children:"Problem Statement"}),"\n",(0,o.jsxs)(n.p,{children:["In Cosmos SDK, the validator set can change upon every block: staking-related messages that affect the validator set\u2019s voting power distribution (e.g., bond/unbond, delegate/undelegate/redegate, slash) can be executed in any block.\nSince checkpointing the validator set to Bitcoin is necessary for Babylon to obtain Bitcoin security, the frequency of checkpointing to Bitcoin has to be same as the frequency of validator set updates.\nIf the validator set changes upon every block, then Babylon has to checkpoint to Bitcoin upon every new block, which is impractical given Bitcoin's block interval of 10 minutes.\nIn addition, the Cosmos community also observed that frequent validator set updates make it challenging to implement threshold cryptography, light clients, fair leader election, and staking derivatives, as discussed in ",(0,o.jsx)(n.a,{href:"https://github.com/cosmos/cosmos-sdk/blob/main/docs/architecture/adr-039-epoched-staking.md",children:"ADR-039"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["In order to reduce the frequency of validator set updates, a natural solution is to implement the epoching mechanism (aka epoched staking), which divides the blockchain into epochs and triggers a validator set update per epoch.\nThe idea of epoching was proposed and formalised in ",(0,o.jsx)(n.a,{href:"https://github.com/cosmos/cosmos-sdk/blob/main/docs/architecture/adr-039-epoched-staking.md",children:"ADR-039"}),", and there have been multiple efforts (",(0,o.jsx)(n.a,{href:"https://github.com/cosmos/cosmos-sdk/pull/8829",children:"https://github.com/cosmos/cosmos-sdk/pull/8829"}),", ",(0,o.jsx)(n.a,{href:"https://github.com/cosmos/cosmos-sdk/pull/10132",children:"https://github.com/cosmos/cosmos-sdk/pull/10132"}),", ",(0,o.jsx)(n.a,{href:"https://github.com/cosmos/cosmos-sdk/pull/10173",children:"https://github.com/cosmos/cosmos-sdk/pull/10173"}),") of implementing it.\nSince Babylon has some extra design goals (e.g., checkpointing epochs) and these efforts have discontinued, Babylon implements its own epoching module."]}),"\n",(0,o.jsx)(n.p,{children:"In addition, in order to achieve slashable safety, Babylon has to implement Bitcoin-assisted unbonding, where an unbonding request is finished only when the corresponding block has been checkpointed on Bitcoin.\nWith the epoching mechanism, all unbonding requests in an epoch will be finished upon this epoch has been checkpointed on Bitcoin."}),"\n",(0,o.jsx)(n.h2,{id:"design",children:"Design"}),"\n",(0,o.jsx)(n.p,{children:"Babylon implements the epoching module in order to reduce the frequency of validator set updates, and thus the frequency of checkpointing to Bitcoin.\nSpecifically, the epoching module is responsible for the following tasks:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Dividing the blockchain into epochs"}),"\n",(0,o.jsx)(n.li,{children:"Disabling some functionalities of the staking module"}),"\n",(0,o.jsx)(n.li,{children:"Disabling messages of the staking module"}),"\n",(0,o.jsx)(n.li,{children:"Delaying staking-related messages (thus validator set updates) till the end of the epoch"}),"\n",(0,o.jsx)(n.li,{children:"Releasing the unbonding queue until the corresponding epoch has been checkpointed on Bitcoin."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"dividing-the-blockchain-into-epochs",children:"Dividing the Blockchain into Epochs"}),"\n",(0,o.jsxs)(n.p,{children:["The epoching mechanism introduces the concept of epochs.\nThe blockchain is divided into epochs, each consists of a fixed number of consecutive blocks.\nThe number of blocks in an epoch is called ",(0,o.jsx)(n.em,{children:"epoch interval"}),", which is a system parameter.\nAt the moment, Babylon uses the epoch interval of 900 blocks, which take about 30 minutes."]}),"\n",(0,o.jsx)(n.h3,{id:"disabling-functionalities-of-the-staking-module",children:"Disabling Functionalities of the Staking Module"}),"\n",(0,o.jsx)(n.p,{children:"Babylon disables two functionalities of the staking module, namely the validator set update mechanism and the 21-day unbonding mechanism."}),"\n",(0,o.jsx)(n.p,{children:"In Cosmos SDK, the staking module handles staking-related messages and updates the validator set upon every block.\nConsequently, the staking module updates the validator set upon every block.\nIn order to reduce the frequency of validator set updates to once per epoch, Babylon disables the validator set update mechanism of the staking module."}),"\n",(0,o.jsxs)(n.p,{children:["In addition, the staking module enforces the 21-day unbonding rule: an unbonding validator or delegation will become unbonded after 21 days (called ",(0,o.jsx)(n.em,{children:"mature validators"}),"*).\nBabylon departs from Cosmos SDK by employing Bitcoin-assisted unbonding that leverages Bitcoin security to achieve slashable safety, where a validator has to be slashed if performing a safety attack.\nIn order to implement Bitcoin-assisted unbonding, Babylon disables the 21-day unbonding mechanism as well."]}),"\n",(0,o.jsxs)(n.p,{children:["In order to disable the two functionalities, Babylon disables staking module's ",(0,o.jsx)(n.code,{children:"EndBlocker"})," function that updates validator sets and unbonds mature validators upon a block ends.\nInstead, upon an epoch has ended, the epoching module will invoke the staking module's function that updates the validator sets.\nIn addition, upon an epoch has been checkpointed to Bitcoin, the epoching module will  invoke the staking module's function that unbonds mature validators."]}),"\n",(0,o.jsx)(n.h3,{id:"disabling-messages-of-the-staking-module",children:"Disabling Messages of the Staking Module"}),"\n",(0,o.jsx)(n.p,{children:"In order to keep the validator set unchanged in the middle of epochs, the epoching module intercepts and rejects staking-related messages that affect validator sets via AnteHandler, but instead defines wrapped versions of them and forwards their unwrapped forms to the staking module upon an epoch ends."}),"\n",(0,o.jsx)(n.p,{children:"Recall that a Cosmos SDK module contains protobuf files for messages in transactions.\nIn the staking module, these messages include"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"MsgCreateValidator"})," for creating a new validator"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"MsgEditValidator"})," for editing an existing validator"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"MsgDelegate"})," for delegating coins from a delegator to a validator"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"MsgBeginRedelegate"})," for redelegating coins from a delegator and source validator to a destination validator."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"MsgUndelegate"})," for undelegating from a delegator and a validator."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"MsgCancelUnbondingDelegation"})," for cancelling unbonding delegation for a delegator"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Within these messages, ",(0,o.jsx)(n.code,{children:"MsgCreateValidator"}),", ",(0,o.jsx)(n.code,{children:"MsgDelegate"}),", ",(0,o.jsx)(n.code,{children:"MsgBeginRedelegate"}),", and ",(0,o.jsx)(n.code,{children:"MsgUndelegate"})," affect the validator set.\nSince Babylon requires the validator set to be unchanged within an epoch, it has to avoid processing these messages in the middle of epochs.\nTo this end, the epoching module defines an AnteHandler to reject these messages.\nInstead, it defines wrapped versions for them in the epoching module: ",(0,o.jsx)(n.code,{children:"MsgWrappedCreateValidator"}),", ",(0,o.jsx)(n.code,{children:"MsgWrappedDelegate"}),", ",(0,o.jsx)(n.code,{children:"MsgWrappedBeginRedelegate"}),", and ",(0,o.jsx)(n.code,{children:"MsgWrappedUndelegate"}),".\nThe epoching module receives these messages at any time, but will only process them at the end of each epoch."]}),"\n",(0,o.jsx)(n.h3,{id:"delaying-wrapped-messages-to-the-end-of-epochs",children:"Delaying Wrapped Messages to the End of Epochs"}),"\n",(0,o.jsx)(n.p,{children:"The epoching module will handle wrapped staking-related messages at the end of each epoch.\nTo this end, the epoching module maintains a message queue for each epoch.\nUpon each wrapped message, the epoching module performs basic sanity checks, then enqueue the message to the message queue.\nWhen the epoch ends, the epoching module will unwrap the queued messages and forward them to the staking module.\nConsequently, the staking module receives and handles staking-related messages, thus performs validator set updates, at the end of each epoch."}),"\n",(0,o.jsx)(n.h3,{id:"bitcoin-assisted-unbonding",children:"Bitcoin-assisted Unbonding"}),"\n",(0,o.jsx)(n.p,{children:"Bitcoin-assisted unbonding is the mechanism that an unbonding validator or delegation becomes unbonded only when the block containing the associated unbonding request is checkpointed by Bitcoin.\nThe mechanism is necessary for achieving slashable safety where a validator has to be slashed if performing a safety attack."}),"\n",(0,o.jsxs)(n.p,{children:["Babylon implements the Bitcoin-assisted unbonding mechanism by invoking the staking module upon an epoch becomes checkpointed.\nSpecifically, the staking module's ",(0,o.jsx)(n.code,{children:"ApplyMatureUnbondings"})," is responsible for identifying and unbonding mature validators and delegations that have been unbonding for 21 days, and is invoked upon every block.\nBabylon has disabled the invocation of ",(0,o.jsx)(n.code,{children:"ApplyMatureUnbondings"})," per block, and implements the state management for epochs.\nUpon an epoch becomes finalized, the epoching module will invoke ",(0,o.jsx)(n.code,{children:"ApplyMatureUnbondings"})," to unbond all unbonding validators and delegations before the end of this epoch."]})]})}function r(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>d});var o=i(6540);const t={},s=o.createContext(t);function a(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);